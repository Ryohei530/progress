<% provide(:title, "日報") %>
<% provide(:button_text, "投稿") %>
<li id="report-<%= @report.id %>" class="report-count">
  <span class="user"><%= link_to @report.user.name, @report.user %></span>
  <span class="content">
    <div class="aim">
      <p>今月の目的</p>
      <%= @report.user.goals.find(9).monthly_aim %>
    </div>
  
    <div class="indicator">
      <p>今月の目標指標</p>
      <%= @report.user.goals.find(9).monthly_indicator %>
    </div>
    
    
    <div class="action">
      <p>今日のアクション</p>
      <%= @report.user.goals.find(9).goal_actions.first.content %>
      <%= @report.report_actions.first.number %>
      /<%= @report.user.goals.find(9).goal_actions.first.number %>
    </div>
    <div class="reflect">
      <p>感想、気付き</p>
      <%= @report.content %>
    </div>
    <%= image_tag @report.images.display if @report.images.attached? %>
  </span>
  <span class="timestamp">
    <%= time_ago_in_words(@report.created_at) %>
    <% if current_user?(@report.user) %>
      <%= link_to "削除", @report, method: :delete,
                                data: { confirm: "本当に削除しますか？" },
                                class: "dlt-report-#{@report.id}" %>
      <%= link_to "編集", edit_report_path(@report) %>
    <% end %>
  </span>
  <div>
    <% like = @report.report_likes.find_by(user_id: current_user.id) %>
    <% if current_user.report_liked?(@report) %>
      <%= link_to report_report_like_path(@report, like), method: :delete do %>
        <span>
          <i class="fas fa-heart"></i>
          <%= @report.report_likes.count %>
        </span>
      <% end %>
    <% else %>
      <%= link_to report_report_likes_path(@report), method: :post do %>
        <span>
          <i class="far fa-heart"></i>
          <%= @report.report_likes.count %>
        </span>
      <% end %>
    <% end %>
  </div>
  <div class="row">
  <div class="col-6 offset-3">
    <%= render 'report_comments/comment_form' %>
    
    <% @comments.each do |comment| %>
      <p><%= comment.user.name %></p>
      <p><%= comment.content %></p>
      <p><%= time_ago_in_words(comment.created_at) %></p>
      <% if comment.user_id == current_user.id %>
          <%= link_to "削除", report_report_comment_path(@report, comment), method: :delete, class: "btn btn-danger" %>
      <% end %>
      <div>
        <% if replies_to_comment = @replies.where(reply_id: comment.id) %>
          <% replies_to_comment.each do |reply| %>
            <div class="ml-2">
              <%= reply.user.name %>
              <%= reply.content %>
              
              <% if reply.user_id == current_user.id %>
                <%= link_to "削除", report_report_comment_path(@report, reply), method: :delete, class: "btn btn-danger" %>
              <% end %>
              <%= render 'report_comments/reply_form', comment: reply %>
              
              <% if replies_to_reply = @replies.where(reply_id: reply.id) %>
                <% replies_to_reply.each do |rep| %>
                  <div class="ml-2">
                    <%= rep.user.name %>
                    <%= rep.content %>
                    
                    <% if rep.user_id == current_user.id %>
                      <%= link_to "削除", report_report_comment_path(@report, rep), method: :delete, class: "btn btn-danger" %>
                    <% end %>
                    <%= render 'report_comments/reply_form', comment: rep %>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
      
      <%= render 'report_comments/reply_form', comment: comment %>
    <% end %>
  </div>
</div>
  <p><%= link_to "日報一覧へ", reports_path %></p>
</li>